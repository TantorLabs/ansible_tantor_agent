# Ansible роль: Tantor Agent 

## Общая информация

Данный репозиторий служит для целей управления жизненным циклом групп агентов (установкой, обновлением, удалением).

## Структура репозитория

```
|-- agent.yml                             # Плейбук, который запускает роль tantor_agent
|-- group_vars                            # Каталог, содержащий набор переменных для групп узлов
|   |-- all.yml                           # Набор переменных, применяемых на всю группу узлов
|-- inventory                             # Файл inventory, который необходимо заполнить для работы ansible
|-- inventory_template                    # Шаблон файла inventory с описанием переменных на английском языке
|-- LICENSE                               # Описание лицензии, по которой распространяется этот плейбук
|-- README.md                             # Описание репозитория на английском языке
|-- README_rus.md                         # Описание репозитория на русском языке
|-- roles                                 # Каталог, содержащий роли, выполняемые ansible
|   |-- tantor_agent                      # Роль tantor_agent, устанавливаемая на все узлы, указанные в плейбуке
|   |   |-- defaults                      # Каталог, содержащий значения по-умолчанию для роли tantor_agent
|   |   |   | -- main.yml                 # Основной файл каталога Defaults
|   |   |-- files                         # Каталог, содержащий дополнительные файлы, используемые в процессе работы ansible
|   |   |   | -- id_rsa.pub               # Публичный ключ, который будет помещён в authorized_keys пользователя postgres
|   |   |-- handlers                      # Каталог, содержащий обработчики событий плейбука
|   |   |   |-- main.yml                  # Основной файл каталога handlers
|   |   |-- meta                          # Каталог, содержащий информацию о роли
|   |   |   |-- main.yml                  # Основной файл каталога meta
|   |   |-- tasks                         # Каталог, сожержащий основные задачи, выполняемые ролью tantor_agent на группе узлов, указанных в плейбуке
|   |   |   |-- agent_deregister.yml      # Файл, содержащий задачи для снятия агента с регистрации
|   |   |   |-- agent_registration.yml    # Файл, содержащий задачи для регистрации агента
|   |   |   |-- delete_agent.yml          # Файл, содержащий задачи для удаления агента
|   |   |   |-- install_agent_local.yml   # Файл, содержащий задачи для установки агента без обращения к внешним репозиториям
|   |   |   |-- install_agent_repo.yml    # Файл, сожержащий задачи для установки агента из внешнего репозитория Tantor
|   |   |   |-- main.yml                  # Основной файл каталога tasks
|   |   |   |-- prepare_nodes.yml         # Файл, содержащий задачи по подготовке узлов к дальнейшей эксплуатации
|   |   |-- tests                         # Каталог, содержащий инструкции для теста роли
|   |   |   |-- inventory                 # Файл inventory для использования во время тестирования роли tantor_agent
|   |   |   |-- test.yml                  # Плейбук для тестирования роли tantor_agent
```

## Требования

На всех узлах, указанных в файле inventory, необходимо наличие компонентов:
* Python3 (с модулем pip) >= 3.10.0;
* СУБД TantorDB или PostgreSQL (включая postgresql-contrib) c внешним управлением Patroni или без внешнего управления;

На узле, с которого будет запускаться плейбук, необходимо наличие компонентов:
* [Ansible](https://docs.ansible.com/ansible/latest/reference_appendices/release_and_maintenance.html) >= 9.5.0 (версия ядра (core version) 2.16);

Плейбук запускается под УЗ, имеющей беспарольный доступ на все узлы inventory файла с возможностью перехода в привелигированный режим (root).

## Подготовительные шаги

В процессе предварительной подготовки плейбука к запуску все файлы, на которые следует обратить внимание, можно идентифицировать, при помощи символов ``# ! #``. Для этого, находясь в каталоге скачанного проекта, выполните:

```bash
grep -r --exclude='*README*' '# ! #' ./* 
./group_vars/all.yml:# ! #
./host_vars/hostnameX.yml:# ! #
./inventory_template:sample_group # ! # This template should be replaced with real group of hosts; When a new group is added (in section below) - it should be also added here;
./inventory_template:[sample_group] # ! # Template group name
./roles/tantor_agent/files/id_rsa.pub:# ! # Put you pub key here. I will be added to postgres user. Replace this line and leave just the public key in this file
```

Заполните файлы, согласно инструкции ниже:

1. На примере файла ``inventory_template``, находящегося в корневом каталоге плейбука, создайте свой собственный  ``inventory``. Обращайте внимание на комментарии в исходном файле;
2. На примере файла ``group_vars/all.yml`` создайте и разместите в каталоге ``group_vars`` новый файл, содержащий переменные для группы узлов из файла ``inventory``(например, файл ``sample_group.yml`` для группы ``sample_group`` из ``inventory_template`` );
3. Заполните файл, созданный в п.2 шага выше, данными, актуальными запуска плейбука в требуемом контуре;
4. При необходимости пропишите публичный ключа пользователя, от имени которого запущена Платформа, в файле ``roles/tantor_agent/files/id_rsa.pub``. Данный ключ будет добавлен пользователю ``postgres``;
5. При необходимости переопределения переменных на уровне узла добавьте файл с именем этого узла и расширением ``.yml`` в каталог ``host_vars`` (например, файл ``hostnameA.yml`` из ``inventory_template``)
6. Замените значение ``sample_group`` из файла ``agent.yml`` на группу, прописанную в файле ``inventory``, для которой будут выполняться все задачи;

## Запуск плейбука

Основной файл переменных, используемый плейбуком, - ``group_vars/<файл созданный в п2 инструкции выше>.yml``. В нём настраивается основная логика работы плейбука.

---
Для запуска плейбука используйте команду:
```bash
ansible-playbook -i <путь к файлу inventory> -l <группа узлов из файла inventory> agent.yml -D
```
